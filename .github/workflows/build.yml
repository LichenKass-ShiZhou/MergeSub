name: Build linuxdeployqt and MergeSub with QT6

on:
  workflow_dispatch:
    inputs:
      build-type:
        description: '构建类型'
        required: false
        default: 'release'
        type: choice
        options:
          - release
          - debug

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 第一步：安装 QT6 和必要的依赖
      - name: Install QT6 and dependencies
        run: |
          sudo apt-get update
          # 添加 QT6 官方仓库（如果需要更新版本的QT6，可考虑添加）
          # sudo add-apt-repository ppa:beineri/opt-qt-6.0-xenial -y  # 根据Ubuntu版本调整
          # sudo apt-get update

          # 安装 QT6 基础开发包和其他可能需要的依赖
          sudo apt-get install -y qt6-base-dev qt6-tools-dev qt6-tools-dev-tools 
          sudo apt-get install -y libgl1-mesa-dev libxcb-xinerama0 libxkbcommon-dev
          # 查找 qmake 的路径，优先查找 qt6 版本
          QMAKE_PATH=$(which qmake6 || which qmake)  # 优先使用qmake6，其次使用qmake
          echo "QMAKE_PATH=$QMAKE_PATH" >> $GITHUB_ENV
          # 验证 qmake 版本
          $QMAKE_PATH -v

      # 第二步：克隆 linuxdeployqt 仓库并进入指定目录
      - name: Clone linuxdeployqt repository
        run: |
          git clone https://github.com/probonopd/linuxdeployqt.git
          cd linuxdeployqt/tools/linuxdeployqt
          git submodule update --init --recursive

      # 第三步：修复 main.cpp 中的语法错误
      - name: Fix main.cpp syntax errors
        run: |
          cd linuxdeployqt/tools/linuxdeployqt
          # 恢复原始文件
          git checkout -- main.cpp 
          sed -i '/if (strverscmp (glcv, "2.36") >= 0) {/,/^        }$/ s/^/\/\//' main.cpp

      # 第四步：在 CMakeLists.txt 文件中添加 CMake 最低版本要求
      - name: Add CMake minimum version requirement
        run: |
          cd linuxdeployqt/tools/linuxdeployqt
          # 在 CMakeLists.txt 文件开头添加 cmake_minimum_required(VERSION 3.31)
          if ! grep -q "cmake_minimum_required" CMakeLists.txt; then
              sed -i '1icmake_minimum_required(VERSION 3.31)' CMakeLists.txt
          fi
          
          # 添加 project() 命令
          if ! grep -q "^project(" CMakeLists.txt; then
              sed -i '/cmake_minimum_required/aproject(linuxdeployqt)' CMakeLists.txt
          fi

      # 第五步：构建 linuxdeployqt 项目 (尝试使用QT6环境，但注意linuxdeployqt可能对QT版本有特定要求)
      - name: Build linuxdeployqt project
        run: |
          cd linuxdeployqt/tools/linuxdeployqt
          # 尝试配置和构建，注意设置QT6相关的路径（如果linuxdeployqt支持）
          # 由于linuxdeployqt最初设计可能针对QT5，此处尝试使其适应QT6环境
          cmake . -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/usr -DCMAKE_PREFIX_PATH=/usr/lib/x86_64-linux-gnu/qt6/
          make -j$(nproc)
          make DESTDIR=appdir -j$(nproc) install
          find appdir/

      # 第六步：安装QT6和必要的依赖（包括quick和multimedia模块）
      - name: Install QT6 and dependencies (including quick and multimedia)
        run: |
          sudo apt-get update
          # 安装QT6基础开发包、quick模块、multimedia模块及其他可能需要的依赖
          sudo apt-get install -y qt6-base-dev qt6-tools-dev qt6-tools-dev-tools 
          sudo apt-get install -y qt6-declarative-dev qt6-multimedia-dev  # 明确安装缺失的模块
          sudo apt-get install -y libgl1-mesa-dev libxcb-xinerama0 libxkbcommon-dev
          # 查找qmake的路径，优先查找qt6版本
          QMAKE_PATH=$(which qmake6 || which qmake)  # 优先使用qmake6，其次使用qmake
          echo "QMAKE_PATH=$QMAKE_PATH" >> $GITHUB_ENV
          # 验证qmake版本
          $QMAKE_PATH -v
    
      # 第七步：克隆并编译 MergeSub 项目 (使用QT6)
      - name: Clone and build MergeSub with QT6
        run: |
          git clone https://github.com/LichenKass-ShiZhou/MergeSub.git
          cd MergeSub
          # 使用QT6的qmake生成Makefile
          $QMAKE_PATH MergeSub.pro
          make -j$(nproc)
          # 验证生成的二进制文件（可选）
          ls -la
          file MergeSub  # 如果生成的可执行文件名为MergeSub

       # 第八步：使用编译好的 linuxdeployqt 处理 MergeSub 以获取其依赖的共享库
      - name: Deploy MergeSub and extract shared libraries using linuxdeployqt
        run: |
          # 进入 MergeSub 构建目录
          cd MergeSub

          # 创建一个专门用于部署的目录
          mkdir -p deploy
          # 复制 MergeSub 可执行文件到部署目录
          cp MergeSub deploy/

          # 进入部署目录
          cd deploy

          # 设置 QT 环境变量，确保 linuxdeployqt 能够找到 QT6 的相关库和插件
          # 这里的路径可能需要根据你系统上 QT6 的实际安装位置进行调整
          export PATH=/usr/lib/x86_64-linux-gnu/qt6/bin:$PATH
          export LD_LIBRARY_PATH=/usr/lib/x86_64-linux-gnu/qt6/lib:$LD_LIBRARY_PATH
          export QT_PLUGIN_PATH=/usr/lib/x86_64-linux-gnu/qt6/plugins:$QT_PLUGIN_PATH
          export QML2_IMPORT_PATH=/usr/lib/x86_64-linux-gnu/qt6/qml:$QML2_IMPORT_PATH

          # 使用之前编译的 linuxdeployqt 处理 MergeSub 可执行文件。
          # 使用 -appimage 参数会触发部署过程，但其最终目的是为了让我们获取依赖库，即使我们不生成最终的 AppImage。
          # 注意：linuxdeployqt 会修改可执行文件中的库搜索路径，并将其依赖的库复制到当前目录（通常是 ./lib）下。
          ../../linuxdeployqt/tools/linuxdeployqt/linuxdeployqt MergeSub -appimage

          # 上述命令执行后，依赖的共享库（.so 文件）应该已经被复制到部署目录下的 lib 文件夹中。
          # 你可以列出 lib 目录的内容进行验证。
          echo "Contents of the lib directory:"
          ls -la lib/ || echo "Lib directory might not exist yet, check for other locations or linuxdeployqt output."

          # （可选）如果 linuxdeployqt 没有将库完全提取或你遇到问题，可以尝试使用 ldd 手动检查依赖
          echo "Dependencies of MergeSub:"
          ldd MergeSub


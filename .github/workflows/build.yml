name: Build linuxdeployqt

on:
  # 允许手动触发工作流
  workflow_dispatch:
    # 可选的输入参数
    inputs:
      build-type:
        description: '构建类型'
        required: false
        default: 'release'
        type: choice
        options:
          - release
          - debug

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 第一步：克隆 linuxdeployqt 仓库并进入指定目录
      - name: Clone linuxdeployqt repository
        run: |
          git clone https://github.com/probonopd/linuxdeployqt.git
          cd linuxdeployqt/tools/linuxdeployqt
          git submodule update --init --recursive
          
      # 第二步：注释掉 glibc 版本检查代码
      - name: Disable glibc version check
        run: |
          cd linuxdeployqt/tools/linuxdeployqt
          # 使用 sed 命令注释掉指定的代码块
          sed -i '/if (strverscmp (glcv, "2.36") >= 0) {/,/^        }$/ s/^/\/\//' main.cpp
          
      # 第三步：在 CMakeLists.txt 文件中添加 CMake 最低版本要求
      - name: Add CMake minimum version requirement
        run: |
          cd linuxdeployqt/tools/linuxdeployqt
          # 在 CMakeLists.txt 文件开头添加 cmake_minimum_required(VERSION 3.31)
          sed -i '1icmake_minimum_required(VERSION 3.31)' CMakeLists.txt

      # 第四步：构建项目
      - name: Build project
        run: |
          cd linuxdeployqt/tools/linuxdeployqt
          # 配置项目
          cmake . -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/usr
          # 编译项目
          make -j$(nproc)
          # 安装到临时目录并列出文件
          make DESTDIR=appdir -j$(nproc) install
          find appdir/

name: Build linuxdeployqt and MergeSub with QT6

on:
  workflow_dispatch:
    inputs:
      build-type:
        description: 'æž„å»ºç±»åž‹'
        required: false
        default: 'release'
        type: choice
        options:
          - release
          - debug

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # ç¬¬ä¸€æ­¥ï¼šå®‰è£… QT6 å’Œå¿…è¦çš„ä¾èµ–
      - name: Install QT6 and dependencies
        run: |
          sudo apt-get update
          # æ·»åŠ  QT6 å®˜æ–¹ä»“åº“ï¼ˆå¦‚æžœéœ€è¦æ›´æ–°ç‰ˆæœ¬çš„QT6ï¼Œå¯è€ƒè™‘æ·»åŠ ï¼‰
          # sudo add-apt-repository ppa:beineri/opt-qt-6.0-xenial -y  # æ ¹æ®Ubuntuç‰ˆæœ¬è°ƒæ•´
          # sudo apt-get update

          # å®‰è£… QT6 åŸºç¡€å¼€å‘åŒ…å’Œå…¶ä»–å¯èƒ½éœ€è¦çš„ä¾èµ–
          sudo apt-get install -y qt6-base-dev qt6-tools-dev qt6-tools-dev-tools 
          sudo apt-get install -y libgl1-mesa-dev libxcb-xinerama0 libxkbcommon-dev
          # æŸ¥æ‰¾ qmake çš„è·¯å¾„ï¼Œä¼˜å…ˆæŸ¥æ‰¾ qt6 ç‰ˆæœ¬
          QMAKE_PATH=$(which qmake6 || which qmake)  # ä¼˜å…ˆä½¿ç”¨qmake6ï¼Œå…¶æ¬¡ä½¿ç”¨qmake
          echo "QMAKE_PATH=$QMAKE_PATH" >> $GITHUB_ENV
          # éªŒè¯ qmake ç‰ˆæœ¬
          $QMAKE_PATH -v

      # ç¬¬äºŒæ­¥ï¼šå…‹éš† linuxdeployqt ä»“åº“å¹¶è¿›å…¥æŒ‡å®šç›®å½•
      - name: Clone linuxdeployqt repository
        run: |
          git clone https://github.com/probonopd/linuxdeployqt.git
          cd linuxdeployqt/tools/linuxdeployqt
          git submodule update --init --recursive

      # ç¬¬ä¸‰æ­¥ï¼šä¿®å¤ main.cpp ä¸­çš„è¯­æ³•é”™è¯¯
      - name: Fix main.cpp syntax errors
        run: |
          cd linuxdeployqt/tools/linuxdeployqt
          # æ¢å¤åŽŸå§‹æ–‡ä»¶
          git checkout -- main.cpp 
          sed -i '/if (strverscmp (glcv, "2.36") >= 0) {/,/^        }$/ s/^/\/\//' main.cpp

      # ç¬¬å››æ­¥ï¼šåœ¨ CMakeLists.txt æ–‡ä»¶ä¸­æ·»åŠ  CMake æœ€ä½Žç‰ˆæœ¬è¦æ±‚
      - name: Add CMake minimum version requirement
        run: |
          cd linuxdeployqt/tools/linuxdeployqt
          # åœ¨ CMakeLists.txt æ–‡ä»¶å¼€å¤´æ·»åŠ  cmake_minimum_required(VERSION 3.31)
          if ! grep -q "cmake_minimum_required" CMakeLists.txt; then
              sed -i '1icmake_minimum_required(VERSION 3.31)' CMakeLists.txt
          fi
          
          # æ·»åŠ  project() å‘½ä»¤
          if ! grep -q "^project(" CMakeLists.txt; then
              sed -i '/cmake_minimum_required/aproject(linuxdeployqt)' CMakeLists.txt
          fi

      # ç¬¬äº”æ­¥ï¼šæž„å»º linuxdeployqt é¡¹ç›® (å°è¯•ä½¿ç”¨QT6çŽ¯å¢ƒï¼Œä½†æ³¨æ„linuxdeployqtå¯èƒ½å¯¹QTç‰ˆæœ¬æœ‰ç‰¹å®šè¦æ±‚)
      - name: Build linuxdeployqt project
        run: |
          cd linuxdeployqt/tools/linuxdeployqt
          # å°è¯•é…ç½®å’Œæž„å»ºï¼Œæ³¨æ„è®¾ç½®QT6ç›¸å…³çš„è·¯å¾„ï¼ˆå¦‚æžœlinuxdeployqtæ”¯æŒï¼‰
          # ç”±äºŽlinuxdeployqtæœ€åˆè®¾è®¡å¯èƒ½é’ˆå¯¹QT5ï¼Œæ­¤å¤„å°è¯•ä½¿å…¶é€‚åº”QT6çŽ¯å¢ƒ
          cmake . -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/usr -DCMAKE_PREFIX_PATH=/usr/lib/x86_64-linux-gnu/qt6/
          make -j$(nproc)
          make DESTDIR=appdir -j$(nproc) install
          find appdir/

      # ç¬¬å…­æ­¥ï¼šå®‰è£…QT6å’Œå¿…è¦çš„ä¾èµ–ï¼ˆåŒ…æ‹¬quickå’Œmultimediaæ¨¡å—ï¼‰
      - name: Install QT6 and dependencies (including quick and multimedia)
        run: |
          sudo apt-get update
          # å®‰è£…QT6åŸºç¡€å¼€å‘åŒ…ã€quickæ¨¡å—ã€multimediaæ¨¡å—åŠå…¶ä»–å¯èƒ½éœ€è¦çš„ä¾èµ–
          sudo apt-get install -y qt6-base-dev qt6-tools-dev qt6-tools-dev-tools 
          sudo apt-get install -y qt6-declarative-dev qt6-multimedia-dev  # æ˜Žç¡®å®‰è£…ç¼ºå¤±çš„æ¨¡å—
          sudo apt-get install -y libgl1-mesa-dev libxcb-xinerama0 libxkbcommon-dev
          # æŸ¥æ‰¾qmakeçš„è·¯å¾„ï¼Œä¼˜å…ˆæŸ¥æ‰¾qt6ç‰ˆæœ¬
          QMAKE_PATH=$(which qmake6 || which qmake)  # ä¼˜å…ˆä½¿ç”¨qmake6ï¼Œå…¶æ¬¡ä½¿ç”¨qmake
          echo "QMAKE_PATH=$QMAKE_PATH" >> $GITHUB_ENV
          # éªŒè¯qmakeç‰ˆæœ¬
          $QMAKE_PATH -v
    
      # ç¬¬ä¸ƒæ­¥ï¼šå…‹éš†å¹¶ç¼–è¯‘ MergeSub é¡¹ç›® (ä½¿ç”¨QT6)
      - name: Clone and build MergeSub with QT6
        run: |
          git clone https://github.com/LichenKass-ShiZhou/MergeSub.git
          cd MergeSub
          # ä½¿ç”¨QT6çš„qmakeç”ŸæˆMakefile
          $QMAKE_PATH MergeSub.pro
          make -j$(nproc)
          # éªŒè¯ç”Ÿæˆçš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
          ls -la
          file MergeSub  # å¦‚æžœç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶åä¸ºMergeSub

      # ç¬¬å…«æ­¥ï¼šä½¿ç”¨ç¼–è¯‘å¥½çš„ linuxdeployqt å¤„ç† MergeSub ä»¥èŽ·å–å…¶ä¾èµ–çš„å…±äº«åº“
      - name: Deploy MergeSub and extract shared libraries using linuxdeployqt
        run: |
          # è¿›å…¥ MergeSub æž„å»ºç›®å½•
          cd MergeSub

          # åˆ›å»ºéƒ¨ç½²ç›®å½•å¹¶å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶
          mkdir -p deploy
          cp MergeSub deploy/
          cd deploy

          # å…³é”®ï¼šèŽ·å–ä¹‹å‰æ­¥éª¤ä¸­è®¾ç½®çš„ QMAKE_PATH
          QMAKE_PATH="${{ env.QMAKE_PATH }}"
          echo "Using qmake path: $QMAKE_PATH"
          
          # æå–QTå®‰è£…è·¯å¾„ï¼ˆå‡è®¾qmakeåœ¨binç›®å½•ä¸‹ï¼‰
          QT_DIR=$(dirname "$(dirname "$QMAKE_PATH")")
          echo "QT directory: $QT_DIR"
          
          # è®¾ç½®å¿…è¦çš„çŽ¯å¢ƒå˜é‡ä»¥ç¡®ä¿èƒ½æ‰¾åˆ°QTæ’ä»¶å’ŒQMLæ¨¡å—
          export LD_LIBRARY_PATH="$QT_DIR/lib:$LD_LIBRARY_PATH"
          export QT_PLUGIN_PATH="$QT_DIR/plugins:$QT_PLUGIN_PATH"
          export QML2_IMPORT_PATH="$QT_DIR/qml:$QML2_IMPORT_PATH"
          
          # ä½¿ç”¨ç¼–è¯‘çš„linuxdeployqtï¼Œå¹¶é€šè¿‡-qmake=å‚æ•°æ˜Žç¡®æŒ‡å®šqmakeè·¯å¾„
          LINUX_DEPLOY_QT_PATH="../../linuxdeployqt/tools/linuxdeployqt/linuxdeployqt"
          chmod +x "$LINUX_DEPLOY_QT_PATH" # ç¡®ä¿å¯æ‰§è¡Œ
          
          # æ‰§è¡Œlinuxdeployqtï¼Œä½¿ç”¨-qmake=å‚æ•°æ˜Žç¡®æŒ‡å®šqmakeè·¯å¾„
          # è¿™æ ·å¯ä»¥é¿å…"qmake not found"é”™è¯¯:cite[3]
          echo "Running linuxdeployqt with explicit qmake path..."
          "$LINUX_DEPLOY_QT_PATH" MergeSub -verbose=1 -qmake="$QMAKE_PATH" 2>&1 | tee linuxdeployqt.log
          
          # æ£€æŸ¥æ‰§è¡Œç»“æžœ
          LINUX_DEPLOY_EXIT_CODE=${PIPESTATUS[0]}
          if [ $LINUX_DEPLOY_EXIT_CODE -eq 0 ]; then
              echo "linuxdeployqt executed successfully!"
          else
              echo "linuxdeployqt failed with exit code $LINUX_DEPLOY_EXIT_CODE"
              echo "Check linuxdeployqt.log for details"
          fi
          
          # æ£€æŸ¥åº“æ–‡ä»¶æ˜¯å¦è¢«æ”¶é›†
          echo "Contents of deployment directory:"
          ls -la .
          echo "Library directory contents (if any):"
          ls -la lib/ 2>/dev/null || echo "No lib directory found. Checking for other locations..."
          
          # å°è¯•ä½¿ç”¨lddæ£€æŸ¥ä¾èµ–ï¼Œä»¥éªŒè¯æ˜¯å¦æ‰€æœ‰ä¾èµ–éƒ½å·²è§£å†³
          echo "Dependencies of MergeSub:"
          ldd MergeSub || echo "ldd command failed"
          
          # å¦‚æžœlinuxdeployqtå¤±è´¥ï¼Œå°è¯•æ‰‹åŠ¨å¤åˆ¶QTåº“
          if [ $LINUX_DEPLOY_EXIT_CODE -ne 0 ]; then
              echo "linuxdeployqtå¯èƒ½å¤±è´¥ï¼Œå°è¯•æ‰‹åŠ¨å¤åˆ¶QTåº“..."
              # ç¤ºä¾‹ï¼šæ‰‹åŠ¨åˆ›å»ºlibç›®å½•å¹¶å¤åˆ¶ä¸€äº›æ ¸å¿ƒQTåº“ï¼ˆéœ€æ ¹æ®å®žé™…éœ€æ±‚è°ƒæ•´ï¼‰
              mkdir -p lib
              cp "$QT_DIR/lib/libQt6Core.so.6" lib/ 2>/dev/null || true
              cp "$QT_DIR/lib/libQt6Gui.so.6" lib/ 2>/dev/null || true
              cp "$QT_DIR/lib/libQt6Widgets.so.6" lib/ 2>/dev/null || true
              # æ³¨æ„ï¼šè¿™åªæ˜¯ä¸€ä¸ªå¤‡é€‰æ–¹æ¡ˆï¼Œå¯èƒ½æ— æ³•è¦†ç›–æ‰€æœ‰ä¾èµ–
          fi
          
          # åˆ—å‡ºæœ€ç»ˆæ”¶é›†åˆ°çš„æ‰€æœ‰åº“æ–‡ä»¶
          echo "Final library collection:"
          find . -name "*.so" -o -name "*.so.*" | sort

          # ç¬¬ä¹æ­¥ï¼šåˆ›å»º DEB åŒ…ç»“æž„å¹¶ä½¿ç”¨ dpkg-shlibdeps èŽ·å–ä¾èµ–
      - name: Create DEB package structure and determine dependencies
        run: |
          # è¿›å…¥éƒ¨ç½²ç›®å½•
          cd MergeSub/deploy
          
          # ä»Ž main.qml æ–‡ä»¶ä¸­æå–ç‰ˆæœ¬å· (æŸ¥æ‰¾ mergeSubVersion å±žæ€§çš„å€¼)
          VERSION=$(grep -oP 'mergeSubVersion:\s*"\K[^"]+' ../../main.qml | head -1)
          if [ -z "$VERSION" ]; then
            VERSION="1.0.0"
            echo "Warning: Version not found in main.qml, using default: $VERSION"
          else
            echo "Extracted version from main.qml: $VERSION"
          fi
          
          # åˆ›å»º DEB åŒ…çš„æ ‡å‡†ç›®å½•ç»“æž„
          mkdir -p deb-package/DEBIAN
          mkdir -p deb-package/usr/bin
          mkdir -p deb-package/usr/lib # åˆ›å»º lib ç›®å½•
          mkdir -p deb-package/usr/share/applications
          mkdir -p deb-package/usr/share/icons/hicolor/256x256/apps
          
          # å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶åˆ° DEB åŒ…çš„ bin ç›®å½•
          cp MergeSub deb-package/usr/bin/
          chmod 755 deb-package/usr/bin/MergeSub
          
          # ðŸŸ¢ å…³é”®æ“ä½œï¼šå°†ç¬¬å…«æ­¥æ”¶é›†çš„ lib æ–‡ä»¶å¤¹å†…å®¹è¦†ç›–åˆ° deb-package/usr/lib/
          # å…ˆæ¸…ç†å¯èƒ½å­˜åœ¨çš„æ—§åº“æ–‡ä»¶ï¼Œç„¶åŽå¤åˆ¶æ–°çš„åº“æ–‡ä»¶
          echo "Copying collected libraries to deb-package/usr/lib/"
          rm -rf deb-package/usr/lib/* # æ¸…ç†ç›®æ ‡ç›®å½•ï¼Œé¿å…æ—§æ–‡ä»¶å¹²æ‰°
          if [ -d "lib" ]; then
            cp -r lib/* deb-package/usr/lib/
            echo "Libraries copied:"
            ls -la deb-package/usr/lib/ || echo "No libraries found in deb-package/usr/lib/"
          else
            echo "Warning: lib directory not found in deploy/. Did linuxdeployqt run successfully?"
            # å³ä½¿ lib ç›®å½•ä¸å­˜åœ¨ï¼Œä¹Ÿç»§ç»­æ‰§è¡Œï¼Œä½†å¯èƒ½å½±å“ä¾èµ–æ£€æµ‹
          fi
          
          # ä½¿ç”¨ echo é€è¡Œåˆ›å»ºæ¡Œé¢æ–‡ä»¶
          echo "[Desktop Entry]" > deb-package/usr/share/applications/MergeSub.desktop
          echo "Version=$VERSION" >> deb-package/usr/share/applications/MergeSub.desktop
          echo "Name=MergeSub" >> deb-package/usr/share/applications/MergeSub.desktop
          echo "GenericName=Subtitle Merger" >> deb-package/usr/share/applications/MergeSub.desktop
          echo "Comment=Tool for merging subtitles" >> deb-package/usr/share/applications/MergeSub.desktop
          echo "Exec=MergeSub" >> deb-package/usr/share/applications/MergeSub.desktop
          echo "Icon=MergeSub" >> deb-package/usr/share/applications/MergeSub.desktop
          echo "Terminal=false" >> deb-package/usr/share/applications/MergeSub.desktop
          echo "Type=Application" >> deb-package/usr/share/applications/MergeSub.desktop
          echo "Categories=Utility;" >> deb-package/usr/share/applications/MergeSub.desktop
          
          # åˆ›å»ºä¸€ä¸ªé»˜è®¤å›¾æ ‡ï¼ˆå¦‚æžœéœ€è¦ï¼‰
          # è¿™é‡Œåˆ›å»ºä¸€ä¸ªç®€å•çš„å ä½ç¬¦å›¾æ ‡
          convert -size 256x256 xc:white -pointsize 30 -fill black -gravity center -annotate +0+0 "MS" deb-package/usr/share/icons/hicolor/256x256/apps/MergeSub.png 2>/dev/null || echo "ImageMagick not available, skipping icon creation"
          
          # èŽ·å–åº”ç”¨ç¨‹åºçš„ä¾èµ–å…³ç³»
          echo "Determining package dependencies..."
          cd deb-package
          
          # ä½¿ç”¨ echo é€è¡Œåˆ›å»ºä¸´æ—¶çš„ control æ–‡ä»¶
          echo "Package: com.github.mergesub" > DEBIAN/control
          echo "Version: $VERSION" >> DEBIAN/control
          echo "Architecture: amd64" >> DEBIAN/control
          echo "Maintainer: LichenKass <yuanchengwei_sz@163.com>" >> DEBIAN/control
          echo "Description: A tool for merging subtitles" >> DEBIAN/control
          echo " A Qt-based application for merging subtitle files." >> DEBIAN/control
          
          # ðŸŸ¢ å…³é”®æ“ä½œï¼šä½¿ç”¨ dpkg-shlibdeps åˆ†æžä¾èµ–ï¼Œå¹¶ä½¿ç”¨ -l å‚æ•°æŒ‡å®šåº“ç›®å½•
          # --ignore-missing-info é€‰é¡¹å…è®¸åœ¨ç¼ºå°‘æŸäº›ä¿¡æ¯çš„æƒ…å†µä¸‹ç»§ç»­:cite[4]:cite[5]
          # -l å‚æ•°æŒ‡å®šåŒ…å«å…±äº«åº“çš„ç›®å½•ï¼Œè¿™é‡ŒæŒ‡å‘æˆ‘ä»¬å¤åˆ¶åº“æ–‡ä»¶çš„ deb-package/usr/lib
          echo "Running dpkg-shlibdeps with explicit library path..."
          dpkg-shlibdeps -O usr/bin/MergeSub --ignore-missing-info -l./usr/lib 2>&1 | tee ../dependencies.log
          
          # æå–ä¾èµ–ä¿¡æ¯
          DEPENDS=$(dpkg-shlibdeps -O usr/bin/MergeSub --ignore-missing-info -l./usr/lib 2>/dev/null | sed 's/^shlibs:Depends=//')
          echo "Detected dependencies: $DEPENDS"
          
          # ä½¿ç”¨ echo é€è¡Œåˆ›å»ºæœ€ç»ˆçš„ control æ–‡ä»¶
          echo "Package: com.github.mergesub" > DEBIAN/control
          echo "Version: $VERSION" >> DEBIAN/control
          echo "Architecture: amd64" >> DEBIAN/control
          echo "Maintainer: LichenKass <yuanchengwei_sz@163.com>" >> DEBIAN/control
          echo "Depends: $DEPENDS" >> DEBIAN/control
          echo "Description: A tool for merging subtitles" >> DEBIAN/control
          echo " A Qt-based application for merging subtitle files." >> DEBIAN/control
          
          # æ˜¾ç¤º control æ–‡ä»¶å†…å®¹
          echo "Final control file:"
          cat DEBIAN/control
          
          # è¿”å›žä¸Šçº§ç›®å½•
          cd ..
          
          # åˆ—å‡º DEB åŒ…ç»“æž„
          echo "DEB package structure:"
          find deb-package -type f -print
